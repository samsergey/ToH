<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF8">
    <script src='../lib/d3.js'></script>
    <script src='../lib/analysis.js'></script>
    <script src='../lib/functions.js'></script>
    <script src='../lib/tools.js'></script>
    <script src='../lib/matrix.js'></script>
    <script src='../lib/statistics.js'></script>
    <script src='../lib/graphics.js'></script>
    <script src='../lib/signal.js'></script>
    <script src='leela.js'></script>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
    .life .A .line {
	stroke : navy;
	stroke-opacity : 0.5;
	stroke-width : 1.5;
        }
    .life .B .line {
	stroke : indianred;
	stroke-width : 2;
	stroke-width : 1.5;
        }
    .life .B1 .line {
	stroke : indianred;
	stroke-width : 2;
	stroke-opacity : 0.7;
        }
    .gridLines {
	stroke : blue;
	stroke-opacity:0.25;
    }
    .deadline .label {
	fill-opacity:1;
	stroke-width:0;
    }
    .above {
	stroke: none;
	fill: #E74C3C;
    }
    .below {
	stroke: none;
	fill: #2471A3;
    }
    .zero {
	stroke: black;
    }
    .year {
	stroke: blue;
	stroke-opacity:0.75;
    }
    .myear {
	stroke: blue;
	stroke-opacity:0.75;
	stroke-dasharray:5,5;
    }
    .month {
	stroke: darkred;
	stroke-opacity:0.75;
    }
    .mmonth {
	stroke: darkred;
	stroke-opacity:0.75;
	stroke-dasharray:5,5;
    }
    .week {
	stroke: darkgreen;
	fill: darkgreen;
    }
    .samples  {
	fill:#B00;
	stroke:white;
	stroke-opacity:0.5;
    }
    .halve1  {
	fill:pink;
	fill-opacity:0.5;
	stroke:black;
    }
    .halve2  {
	fill:palegreen;
	fill-opacity:0.5;
	stroke:black;
    }
    .leela {
	stroke : navy;
	stroke-opacity:0.01;
	stroke-width:0.3;
    }
    .matrixPlot .zeros {
	fill:gray;
    }
    .matrixPlot .positives {
	fill:navy;
    }

    .cycles .bar {
	fill:darkred;
	fill-opacity: 0.7;
    }
    .cycles .label {
	font-family:times;
	font-size:90%;
    }
    .polarMesh {
	stroke: gray;
	stroke-width:0.5;
    }
    .angular .line {
	fill:darkorange;
	stroke:red;
    }
    .stairs {
	stroke:darkorange;
	stroke-width:5;
    }
    .queue {
	stroke:navy;
	fill:navy;
	fill-opacity:0.5;
    }
</style>
  </head>
    <body>
    <svg id='fig1' width='400' height='300'></svg>
    <script>
    
var fig1 = d3.select("#fig1")


function insideQueue()
{
    q1=PoissonProcess(50/60).runToVal(20).map(([t,x])=>[t,20-x])
    q2=PoissonProcess(50/60).runToVal(20).map(([t,x])=>[t,20-x])
    new Graphics(fig1)
	.xRange([0,max(q1.last()[0],q2.last()[0])])
	.yRange([0,20])
	.listStairsPlot(q1,{'class':'year'})
    	.listStairsPlot(q2,{'class':'week'})
	.axes({xLabel:"время (минуты)",
	       yTicks:5,
	       yLabel:"длина очереди"})
}

//insideQueue()

function runQueue(d,W,B)
{
    var q = [], t0 = 0
    d.forEach(([t,n])=>{
	q = q.map(x => x+(t-t0))
	if (q.length == 0 && n > 0) b = t
	if (q.length > 0 && n == 0) { B.add(t-b); b = 0; }
	if (n > q.length) q.unshift(0)
	if (q.length>0 && n < q.length) W.add(q.pop())
	t0 = t
    })
}

function queueExample(q)
{
    new Graphics(fig1)
	.listStairsPlot(q,{'filled':true,
			   'joined':false,
			   'class':'queue'})
	.axes({xLabel:"время (часы)",
	       yTicks:5,
	       yLabel:"длина очереди"})
}

//queueExample(MM1(10,15,0.1).runToTime(10))
//queueExample(MD1(10,13).runToTime(10))
//queueExample(MG1(10,toGamma(1/15,9/15/15)).runToTime(10))

function queueStat(q)
{
    W = new Histogram(0.01)
    B = new Histogram(0.01)
    repeat(10,()=>runQueue(q,W,B))
}

function errors()
{
    var l = 10, m = 15
    w = x => (m+l*(x**3-1))/(m-l)**2
    var r = range(0,1.1,0.1)
	.map(e => {
	    W = new Histogram(0.01)
	    queueStat(MM1(l,m,e).samples(100000));
	    console.log(e)
	    return [e,W.mean/w(0)]
	})
    new Graphics(fig1)
	.yRange([0,w(1)/w(0)+1/2])
	.xRange([0,1])
	.listPlot(r)
	.plot(e => w(e)/w(0))
	.gridLines({y:[w(1)/w(0)]})
	.axes({xLabel:"доля внеочерендников",
	       xTickFormat : fmt.percent,
	       xTicks:5,
	       yTicks:false,
	       yLabel:"время ожидания"})
}
//errors()

function errors2()
{
    var l = 10, m = 15
    var r = range(11,30,1)
	.map(m => {
	    W = new Histogram(0.01)
	    queueStat(MM1(l,m,1).samples(10000));
	    console.log(m)
	    return [m/(m-l)**2,W.mean]
	})
    new Graphics(fig1)
	.yRange([0,20])
	.xRange([0,20])
	.listPlot(r.map(([x,y])=>[1/x,1/y]))
	.plot(m => m)
	.axes({xLabel:"доля внеочередников",
	       yTicks:5,
	       yLabel:"время ожидания"})
}
//errors2()

function errors3()
{
    var l = 10, m = 15
    w = x => (m+l*(x**3.5-1))/(m-l)**2
    var r = range(0,1.01,0.01)
	.map(e => {
	    W = new Histogram(0.01)
	    B = new Histogram(0.01)
	    queueStat(MM1(l,m,e).samples(100000));
	    console.log(e)
	    return [e,W.mean,B.mean]
	})
    new Graphics(fig1)
	.yRange([0,40])
	.xRange([0,1])
	.listPlot(r.map(([e,w,b])=>[e,w*60]),{'class':'above'})
    	.listPlot(r.map(([e,w,b])=>[e,b*60]))
//	.plot(e => w(e),{'class':'myear'})
	.gridLines({y:[w(1)*60]})
	.axes({xLabel:"доля внеочередников",
	       xTickFormat : fmt.percent,
	       xTicks:5,
	       yTicks:5,
	       yLabel:"время (минуты)"})
	.label("W",{at:[0.7,28]})
    	.label("B",{at:[0.7,8]})
}
errors3()

//queueStat(MM1(10/60,15/60).samples(10000))
//queueStat(MG1(10,toGamma(1/15,9/15/15)).samples(10000))

const Waiting = (l,m,x) => ((l/m+l*m*x*x/m/m)/(2*(m-l))+1/m)

const WaitingDL = (l,m,x) => l/m*(x^2 - 1)/2 + 1

function toGamma(m,v)
{
    return Gamma(m*m/v,m/v)
}

function queueTimes(l,m)
{
    var ws=[],bs=[],r=l/m
    new Graphics(fig1)
	.xRange([0,2])
    	.yRange([0,1.5])
	.plot(x => 1+r/2*(x-1))
	.axes({xLabel:"относительная вариация",
	       yLabel:"отношение B/W",
	       yTickValues : [0],
	       xTickValues:[0,1],
	       xTickFormat:fmt.int,
	       yTickFormat:fmt.int})
	.gridLines({y:[1]})
}

//queueTimes(10,15)

function queueTimes2(l,m,s)
{
    var f = x=>toGamma(1/m,s/m/m).PDF(x+0.5)+0.2/x
    new Graphics(fig1)
	.xRange([0.001,30])
	.yRange([0,0.2])
	.plot(x=>Exponential(l).PDF(x),{'class':'year'})
	.plot(x=>f(x),{'class':'month'})
	.axes({xLabel: "периоды времени (минуты)",
	       yLabel: "плотность вероятности",
	       yTicks: 5})
	.line([[1/l,0],[1/l,Exponential(l).PDF(1/l)]],{'class':'myear'})
	.line([[1/m,0],[1/m,f(1/m)]],{'class':'mmonth'})
}

//queueTimes2(10/60,15/60,9)

function queueTimes3(l,m,s)
{
    var r=l/m
    var W,B
    v = s/m/m
    W = new Histogram(0.1)
    B = new Histogram(0.1)
    runQueue(MG1(l,toGamma(1/m,v)).samples(1000),W,B)

    new Graphics(fig1)
	.xRange([0,5])
	.yRange([0,2])
	.histogram(W,{'type':'PDF'})
	.histogram(B,{'type':'PDF','class':'queue'})
	.axes({})
    
}
//queueTimes3(10,15,2)
    </script>
  </body>
</html>
