var touchmoved;
var max_width = 1236;
var num_lightbox = 0;
var max_img_dimension = 1200;
var is_margin_change = false;
var is_cabinet_home_hidden = false;
var homePageTimer;

loadCSS = function(href) {
    var cssLink = $("<link>");
    $("head").append(cssLink); //IE hack: append before setting href

    cssLink.attr({
        rel:  "stylesheet",
        type: "text/css",
        href: href
    });
};

function homePageScrollTop () {
    if ($('#dropmenu').css('display') == 'block') {
        $('.home').show();
        $('nav.main-nav').css({'background-color':'#d1d1d1',"border-bottom":"2px solid white"});
        $('.nav-bg').show();
    } else {
                        
        if ($('.current-issue').size()) {
            if ($(window).scrollTop() <= 70 ) {                          
                $('.home').fadeOut('fast')    
                if ($(window).width() <= 650)        
                    $('nav.main-nav').css({'background-color':'transparent',border:0});
                $('.nav-bg').hide();            
            } else {                                
                $('.home').fadeIn('fast')            
                $('nav.main-nav').css({'background-color':'#d1d1d1',"border-bottom":"2px solid white"});
                $('.nav-bg').show();
            }
            homePageTimer = setTimeout (homePageScrollTop,500)
        } else {       
            $('.home').show();
            $('nav.main-nav').css({'background-color':'#d1d1d1',"border-bottom":"2px solid white"});   
            $('.nav-bg').show();  
            clearTimeout (homePageTimer);
        }
    }
}

function toggleCabinetHome (is_show) {
    if ($('.homepage').size() && $(window).width() <= 600) {
        if (is_show) {
            $('nav .home').show();
            $('.main-nav').css('border-bottom','2px solid white')
        } else {
            $('nav .home').hide();
            $('.main-nav').css('border-bottom',0)
        }   
    }
}

function iOS() {

  var iDevices = [
    'iPad Simulator',
    'iPhone Simulator',
    'iPod Simulator',
    'iPad',
    'iPhone',
    'iPod'
  ];
    var isAndroid = /(android)/i.test(navigator.userAgent);

  if (!!navigator.platform) {
    while (iDevices.length) {
      if (navigator.platform === iDevices.pop()){ return true; }
    }
  } else if (isAndroid)
    return true;


  return false;
}

function showSubheading (text) {
    var tmp  = text.trim();
    var html = '<nav class="subnav bc-16-1">';
    if (tmp == 'Press')
        html += '<a href="/information/press/" class="link selected">'+tmp+'</a>';          
    else
        html += '<a class="link selected">'+tmp+'</a>'; 
    html += '</nav>';
    
    if (tmp == 'Cabinet Press') {
        $('.related_img_cap').css({'margin-bottom':0,'margin-top':0});  
    }
    
    $('.main-nav').after(html); 
}

function isInt(n) {
    return n % 1 === 0;
}

function sumUp (items) {
    return eval(items.join("+"));
}

function jumpLink (target) {
    var tmp = $('a[name="' + target + '"]').position().top;    
    tmp += $('.main-nav').outerHeight(true)+$('.sub-nav').outerHeight(true)
    $(window).scrollTop(tmp);
}

function collision($div1, $div2) {
      var x1 = $div1.offset().left;
      var y1 = $div1.offset().top;
      var h1 = $div1.outerHeight(true);
      var w1 = $div1.outerWidth(true);
      var b1 = y1 + h1;
      var r1 = x1 + w1;
      var x2 = $div2.offset().left;
      var y2 = $div2.offset().top;
      var h2 = $div2.outerHeight(true);
      var w2 = $div2.outerWidth(true);
      var b2 = y2 + h2;
      var r2 = x2 + w2;

      if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
      return true;
}


function doResize () {
     var margins = getMargins ();
    
    $('body, nav').width($(window).width()-(margins*2));    
    
    if ($('.listing').length)
        doItemize ()
        
    if ($('.archive-header').length) {
        $('.archive-header').width($(window).width()-(margins*2));
    }
    
    $('footer').removeAttr ('style');   
    
    if ($('footer').position().top < $(window).height()) {
        
        $('footer').css ({'position':'fixed',bottom:'0px',width:($(window).width()-(margins*2))+'px',left:'24px'}); 
        if ($('.social-media').length)
            $('.social-media').css({bottom:'100px'})
    }

    // Re-check for collision
    if ($('footer').size() && $('.copy').size()) {
        if (collision($('footer'), $('.copy'))) {
            $('footer').removeAttr ('style');   
        }
    }

    
    navAdjustment ();
    
    if ($('.subnav .link').size() == 1)
        $('.subnav .link').css({'margin-right':'0px'});    
    
    if ($(window).width() <= 650) {
        $('.bg-white').remove();        
        
        if ($('.bg').size()) {
            $('.bg').each(function() {

                var width = $(window).width();
                var height = $(this).height();
                var left = 0;
                var top = $(this).offset().top;

                $('body').append('<div class="bg-white" style="width:'+width+'px;height:'+height+'px;top:'+top+'px;left:0px"></div>');
            });
        }
        
        if ($('cite').size()) {
            $('cite').each(function() {

                var width = $(window).width();
                var height = $(this).height();
                var left = 0;
                var top = $(this).offset().top;

                $('body').append('<div class="bg-white" style="width:'+width+'px;height:'+height+'px;top:'+top+'px;left:0px"></div>');
            });
        }
    }        
    
    subnavAdjustment ();
    resizeLightBox ();
    doSocialMedia ();   

    doMainNav ();
}

function adjustArrows (obj) {
     if ($('.subnav .link').height() > $('.subnav').height()) {
        var old_top = parseInt(obj.css('margin-top')) + $('.link.white-only').height() - $('.subnav').height();
        var arrow_top = ($('.link').height() -  $('.left-arrow').height())/2
        obj.css ({'margin-top':old_top+'px'});
        $('.right-arrow').css({top:arrow_top+'px'})
        $('.left-arrow').css({top:arrow_top+'px'})
    }
}

function subnavAdjustment () {
    if ( $('.subnav').size()) {
        if ($(window).width() <= 650) {
            if ($('.book-content').size() || $('.issue-content').size()) {
                $('.subnav').css({height:'53px',overflow:'auto',display:'flex','justify-content':'center','align-items':'center'});
                $('.subnav .link').css({'line-height':'normal'})
                if ($('.book-content').size()) {               
                    adjustArrows ($('.book-content'))
                } else  if ($('.issue-content').size()) {                
                    adjustArrows ($('.issue-content'))
                }
            } else if ($('.subscribe-content').size()) {
                $('.subnav').css({display:'block',height:'auto','padding-bottom':'10px',overflow:'auto'})
                $('.subnav a').css({'line-height':'normal',display:'inline-block','padding-top':'10px','padding-left':'5px','padding-right':'5px'})
            }
        } else {
            $('.subnav').removeAttr('style');
            $('.subnav').css('width',$('.main-nav').width()+'px')
            if ($('.subscribe-content').size()) {
                $('.subnav .link').removeAttr('style');
            } else {
                $('.subnav .link').css('line-height','')            
            }
        }
    }
}


function doMainNav () {    
    if ($('.main-nav span.linker a').css('display') == 'inline') {
        $('.main-nav').css({'background-color':'#d1d1d1','border-bottom':'2px solid white'});
    }
}

function doSocialMedia () {
     if ($(window).width() <= 920 && $('.issue-content').size()) {     
        if (!$('.mobile-social-media').size())   {
            var html = '<div class="mobile-social-media"><span>Share</span> '+$('.social-media').html()+'</div>';
            $( html ).insertBefore( $( "footer" ) );
        } else {
            $('.mobile-social-media').show();
        }
        $('.social-media').hide();    
        $('footer').css({'margin-top':'16px'});

        if ($('.bg-white:last').size()) {
            var last_bg_top = $('.bg-white:last').position().top+$('.bg-white:last').height();
            if (last_bg_top >= $('.mobile-social-media').position().top)
                $('.mobile-social-media').css({'margin-top':'20px'})
        }
    } else {
        $('.mobile-social-media').hide();
        $('.social-media').show();
        $('footer').css({'margin-top':'40px'});

    }    
}

function doActiveMainNav (title) {
    if ($(window).width() <= 650) {
        if (title == 'Books') {
            $('.listing').css('margin-top','51px');
            is_margin_change = true;
        } 
    }
    
    $('.main-nav a').each(function () { 
        if ($(this).text() == title)
            $(this).addClass('selected')
    });
}

function gapLightboxCorrection (obj) {
    var prev = null;
    var did_append = 0;
    $(obj).each(function () {
        if (prev) {
            if ($(this).hasClass('lightbox-area') && prev.hasClass('photo-caption')) {
                $(this).css('margin-top','0');                  
            } else if ($(this).hasClass('lightbox-area') && prev.hasClass('title'))  {
                $(this).css('margin-top','0');                  
            }
            
            if (prev.hasClass('photo-caption') && $(this).hasClass('bio')) {
                prev.css({'padding-bottom':'20px'})     
            }

            if (prev.hasClass('bg') && $(this).hasClass('bg')) {
                prev.find('.padding').append ($(this).find('.padding').html());
                did_append = 1;
            } else
                did_append = 0;
        }

        if (did_append)
            $(this).remove();
        else
            prev = $(this);         
        
        if (prev.hasClass('photo-caption') && !prev.text().length)
            prev.css({'padding-top':0})     
    });
    
    if ($('.info').length) {
        $('.info').parent().css({'margin-top':'5px'})       
    }
    
    if ($('cite').length) {
        if ($('cite').find('ol').size())
            $('cite').prev().find('.padding').css({'padding-bottom':'1px','margin-bottom':'-6px'});
    }
}

function getMargins () {
    var margins = 24;
    
    if ($(window).width() <= 768)
        margins = 20;
    
    return margins;
}

function doItemize () {
    var items = [];
    var items_row = [];
    var new_width = $('.listing').width();  
    
    var max_col = 3;
    var margins = getMargins ();
    
    if ($(window).width() < 600) {
        max_col = 1;
    } else if ($(window).width() < 900) {
        max_col = 2;        
    }
    
    if (new_width > $(window).width()) {
        new_width -= (margins*2);   
    }    
        
    var col_width = new_width - (4*max_col);

    col_width = (col_width/max_col);
    var cur_row = 1;
    var cur_height = 0;
    var num_fill = [];  
    $('.divider').remove();
    $('.listing .item').each (function (index) { 
        var num_col = parseInt($(this).data('col'));
        
        // If this true, then we assume it is only 1 column
        if (!isNaN(num_col) && $(window).width() < 900)
            num_col = 1;
        
        if (!isNaN(num_col)) {
            $(this).width(col_width*num_col);
            $(this).css('margin-left','0px');           
            $(this).css('clear','none');
                
            if ($(this).outerHeight() > cur_height)
                cur_height = $(this).outerHeight();
            
            if (!index) { // First item will always be in the first row
                items[cur_row] = [];
                items_row [cur_row] = 1;
                items[cur_row].push({'index':index,'margin':0,'fill':0});
            } else {
                var cur_pos = $(this).position();
                var prev_pos = $(this).prev().position();

                // If this child is not the same row as the previous sibling then
                // check the x position
                if (cur_pos.top != prev_pos.top) { 
                    // If this child is not the same x position as the previous sibling then
                    // it is in a new row.
                    if (cur_pos.left != prev_pos.left) {
                        $(this).css('clear','left');
                        cur_row++;
                        cur_height = $(this).outerHeight();
                            
                        num_fill = [];
                        items[cur_row] = [];
                        items_row [cur_row] = 1;
                        items[cur_row].push({'index':index,'margin':0,'fill':0});
                    } else {
                        if (num_fill.length == 0)
                            num_fill.push ($(this).prev().outerHeight())                            
                        
                        num_fill.push ($(this).outerHeight())

                        if (sumUp (num_fill) > cur_height) {
                            $(this).css('clear','left');
                            cur_row++;
                            items[cur_row] = [];
                            cur_height = $(this).outerHeight();
                            num_fill = [];
                            items_row [cur_row] = 1;
                            items[cur_row].push({'index':index,'margin':0,'fill':0});
                        } else
                            items[cur_row].push({'index':index,'margin':1,'fill':1});                       
                    }
                } else {
                    items_row [cur_row] += 1;                   
                    num_fill = [];
                    items[cur_row].push({'index':index,'margin':1,'fill':0});
                }
            }               
        }
    });

    col_width = new_width;
    col_width -= ((margins*(max_col-1)+(4*max_col)));
    col_width = col_width/max_col;  
    
    for (var i = 1; i <= cur_row; i++) {
        var cnt = items[i].length;
        
        for (var j = 0; j < cnt; j++) {
            
            var tmp = items[i][j]; 
            var elm = $('.listing .item').get(tmp.index);
            $(elm).css('margin-left',(margins*tmp.margin)+'px');    
            var num_col = $(elm).data('col');
            
             // If this true, then we assume it is only 1 column
            if (!isNaN(num_col) && $(window).width() < 900)
                num_col = 1;

            if (i > 1 && j == 0 && $('.issues').length)
                $(elm).before('<div class="divider"></div>');
            
            if (num_col == 2)
                $(elm).width((col_width*2)+4+margins);              
            else if ($(elm).hasClass('current-issue') || $(elm).hasClass('img-only'))
                $(elm).width((col_width*num_col)+4);                    
            else
                $(elm).width(col_width*num_col);
        }
    }

}

function showActivitiesNav (selected) {
    var html = '<nav class="subnav bc-16-1">';
    html += '<a href="/events/" class="link';
    if (selected == 'Events')
        html += ' selected';
    html += '">Events</a>';
    
    html += '<a href="/projects/" class="link';
    if (selected == 'Projects')
        html += ' selected';
    html += '">Projects</a>';
    
    html += '<a href="/exhibitions/" class="link'
    if (selected == 'Exhibitions')
        html += ' selected';
    html += '">Exhibitions</a>';
    
    html += '</nav>';
    
    $('.main-nav').after(html);
}

function showSubscribeNav (selected) {
    var html = '<nav class="subnav bc-16-1">';
    html += '<a href="/subscribe/" class="link';
    if (selected == 'Individual')
        html += ' selected';
    html += '">Individual</a>';
    
    html += '<a href="/subscribe/institutional.php" class="link';
    if (selected == 'Institutional')
        html += ' selected';
    html += '">Institutional</a>';
    
    html += '<a href="/subscribe/preview.php" class="link'
    if (selected == 'Preview magazine')
        html += ' selected';
    html += '">Preview magazine</a>';
    
    html += '<a href="/subscribe/faq.php" class="link'
    if (selected == 'FAQ')
        html += ' selected';
    html += '">FAQ</a>';
    
    html += '</nav>';
    
    $('.main-nav').after(html);    
}


function showMagazineNav (selected) {
    var html = '<nav class="subnav bc-16-1">';
    html += '<a href="/issues/allissuesbycover.php" class="link';
    if (selected == 'Issues')
        html += ' selected';
    html += '">Issues</a>';
    
    html += '<a href="/contributors/" class="link';
    if (selected == 'Contributors')
        html += ' selected';
    html += '">Contributors</a>';
    
    html += '<a href="/archive/" class="link'
    if (selected == 'Archive')
        html += ' selected';
    html += '">Archive</a>';
    
    html += '</nav>';
    
    $('.main-nav').after(html);
}

function showBlogNav (selected) {
    var html = '<nav class="subnav bc-16-1">';
    html += '<a href="/blog/" class="link';
    if (selected == 'Posts')
        html += ' selected';
    html += '">Posts</a>';
    
    html += '<a href="/blog/contributors/" class="link';
    if (selected == 'Contributors')
        html += ' selected';
    html += '">Contributors</a>';
    
    html += '<a href="/blog/archive/" class="link'
    if (selected == 'Archive')
        html += ' selected';
    html += '">Archive</a>';
    
    html += '</nav>';
    
    $('.main-nav').after(html);	
}

function resetDropmenu () {
    var tmp = $(window).height() - parseInt($('body').css('margin-top'));
    $('#dropmenu').height(tmp);
}

function resizeLightbox () {
    if ($('.lightbox').is(':visible') === true) {
        $('.lightbox').hide();
        var new_width = max_img_dimension;
        var new_height = max_img_dimension;
        var height_gap = 2*64;
        if ($(window).height()-height_gap < max_img_dimension)
            new_height = $(window).height()-height_gap;
                
        if ($(window).width() < max_img_dimension)
            new_width = $(window).width();
                            
        $('.lightbox .pic').css({'margin-left':'-'+(new_width/2)+'px','margin-top':'-'+(new_height/2)+'px',width:new_width+'px',height:new_height+'px'});       
                $('.lightbox').show();
    }
}

function enableArrowKey () {
    $(document).keydown(function(e) {
        switch(e.which) {
            case 37: // left
                if ($('.left-arrow').length)
                    $('.left-arrow').get(0).click();
                break;
/*
            case 38: // up
                break;
*/
            case 39: // right
                if ($('.right-arrow').length)               
                    $('.right-arrow').get(0).click();
                break;
/*
            case 40: // down
                break;
*/
            default: return; // exit this handler for other keys
        }
        e.preventDefault(); // prevent the default action (scroll / move caret)
    }); 
}

function resizeLightBox () {
    if ($('.lightbox').size()) {
        var new_width = max_img_dimension;
        var new_height = max_img_dimension;
        var gap_heights = (2*24)+(2*40);
        if ($(window).height()-gap_heights < max_img_dimension)
            new_height = $(window).height()-gap_heights;

        if ($(window).width()-gap_heights < max_img_dimension)
            new_width = $(window).width()-gap_heights;

        $('.lightbox .pic').css({'margin-left':'-'+(new_width/2)+'px','margin-top':'-'+(new_height/2)+'px',width:new_width+'px',height:new_height+'px'});
    }
}

function displayLightBox (obj) {
    if (obj.data('caption')) {
        var cur_pos = obj.data('caption');
        $('.lightbox .caption').html($('#pc-'+cur_pos).text()); 
        $('.lightbox').data('position',cur_pos);

        if (cur_pos-1 > 0)
            $('.lightbox .left-arrow').show();
        else
            $('.lightbox .left-arrow').hide();

        if (cur_pos+1 <= num_lightbox)
            $('.lightbox .right-arrow').show();
        else
            $('.lightbox .right-arrow').hide();
    }

    var img = obj.find('.pic').attr('src');
    $('.lightbox .pic').css({'background-image':'url("'+img+'")','background-size':'contain','background-position':'center center','background-repeat':'no-repeat'});
    resizeLightBox ();

    $('.lightbox').fadeIn('fast',function () {
        if ($('.lightbox .caption').length  && $('.lightbox .caption').text()) {
            var item = $('.lightbox .caption');
            var tmp = item.text();

            $clamp(item[0], {clamp: 1, useNativeClamp: false,truncationChar:'...'});    

            if (tmp.length < item.text().length) {
                $('.lightbox .caption').text(tmp);
            } else {
                var tmp = $('.lightbox .caption').text();
                if (tmp.indexOf('...') != -1)
                    $('.lightbox .caption').append('<a class="read-more bc-11-1_5">READ MORE</a>');
            }
        }
    });
    $('html').css('overflow','hidden'); 
}


function navAdjustment () {
    
    if ($('#nav-icon').hasClass('open')) {         
        if ($(window).width() <= 600) {
 
            $('.main-nav span.linker').hide();
            $('nav .search').hide();
            
        } else if ($(window).width() <= 768) {
            $('.main-nav span.linker').hide();
            $('nav .search').hide();
             $('.main-nav').css('border-bottom',0);
        } else {
            $('.main-nav').css('border-bottom','2px solid white');
        }
    } else {         
        if ($(window).width() <= 600) {
           
            if ($('.homepage').size())
                $('nav .home').hide();
            else
                $('nav .home').show();
            
            $('nav .search').show();
            $('.main-nav').css('border-bottom',0)
        } else if ($(window).width() <= 768) {
            $('.main-nav span.linker').show();
            $('nav .search').show();
            $('.main-nav').css('border-bottom',0)
        }   
        
        if ($(window).width() <= 768) {
            if ($('.current-issue').length) {
                if (collision($('.logo'),$('.home')) || $(window).scrollTop() == 0) {                   
                    $('.home').hide()
                    $('nav.main-nav').css({'background-color':'transparent',border:0});
                    $('.nav-bg').hide();
                } else {                                
                    $('.home').show()                    
                    $('nav.main-nav').css({'background-color':'#d1d1d1',"border-bottom":"2px solid white"});
                    $('.nav-bg').show();
                }


            }

            if ($('.homepage').size() && $(window).scrollTop() < $('.logo').outerHeight()-30) {        
                // Do nothing
            } else {
                $('.nav-bg').show();
                $('.main-nav').css({'background-color':'#d1d1d1','border-bottom':'2px solid white'});
            }
        }    
    }
}

var prev_scrolltop;
var is_animated = false;
var tmp_caption = '';
$(document).ready(function() {

    if (!iOS()) {
        loadCSS("/css/es-common-hover.css");
    } else {
        if ($('iframe').size()) {
            setTimeout(function(){$('#preloading').fadeOut('fast');}, 2000);
        }
    }

    // Remove  LSEP (line separator) and PSEP (paragraph separator)
    if ($('div.copy.blog-content').size()) {
        var tmp = $('div.copy.blog-content').html().replace(/\u2028/g, '').replace(/\u2029/g, '');
        $('div.copy.blog-content').html(tmp);
    } else if ($('div.copy').size()) {        
        var tmp = $('div.copy').html().replace(/\u2028/g, '').replace(/\u2029/g, '');
        $('div.copy').html(tmp);
    }  
    
    if ($('div.copy.search').size()) {
        $("body").on('DOMSubtreeModified', "div.copy.search", function() {
            // Re-check for collision
            if (collision($('footer'), $('.copy'))) {
                $('footer').removeAttr ('style');   
            }
        });
    }

    if ($('.event-content .photo-caption').size()) {
        $('.event-content .photo-caption').each(function() {
            if ($(this).text() == "")
                $(this).css({'padding-top':0,'padding-bottom':0})
        })
    }

    if ($('.column_description').size()) {
        $('.column_description').each(function () {
            if ($(this).text() == '')
                $(this).remove();
        });
    }
    
    if ($('.current-issue').length)
        $('.home').hide();

    $('#nav-icon').on('click touchend', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            if ($('.home').css('display') == 'block')
                is_cabinet_home_hidden = false;
            else
                is_cabinet_home_hidden = true;

            if ($('#dropmenu').css('display') == 'block') {     
                
                if (prev_scrolltop)
                    $('.return-to-top').fadeIn('fast');
                
                $('.dropmenu-bg').fadeOut('fast');
                $('#dropmenu').fadeOut('fast');
                $('.selected').css('color','#f36e21');
                $('.copy').fadeIn('fast',function() {
                    $(window).scrollTop(prev_scrolltop);
                }); 

                if ($('.bg-white').size() && $(window).width() <= 650)
                    $('.bg-white').fadeIn('fast');

                $('footer').fadeIn('fast');
                if ($('.social-media').length)          
                    $('.social-media').fadeIn('fast');

                toggleCabinetHome (!is_cabinet_home_hidden)   
                doSocialMedia ();
            } else {
                            
                prev_scrolltop = $(window).scrollTop();
                toggleCabinetHome (1);
                        
                if ($('nav .selected').text() == 'Blog') {
                    $('.selected').css('color','#dcdcdc');                          
                } else {        
                    $('.selected').css('color','black');            
                }
                $('.dropmenu-bg').css({width:$(window).width(),height:$(window).height()})
                $('.dropmenu-bg').fadeIn('fast',function(){$(window).scrollTop(0);});
                $('#dropmenu').fadeIn('fast');
                $('.copy').fadeOut('fast');

                if ($('.bg-white').size())
                    $('.bg-white').fadeOut('fast');
                $('footer').fadeOut('fast');    
                
                if ($('.social-media').length)
                    $('.social-media').fadeOut('fast');
            }
            $(this).toggleClass('open');
            navAdjustment ();   
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });


    $(window).scroll(function () {
        var scroll = $(window).scrollTop();
         homePageScrollTop ();
        if (!is_animated) {
            is_animated = true;     

            if (scroll == 0) {
                
                if ($('.archive-header').length)
                    $('.archive-header').fadeIn('fast');
                                
                if ($('.subnav').length) {
                    subnavAdjustment ();
                    $('.subnav').fadeIn('fast')
                }
                
                $('.return-to-top').fadeOut('fast', function () {is_animated = false})
            } else {
                    
                if ($('.archive-header').length)
                    $('.archive-header').fadeOut('fast');
                
                if ($('.subnav').length)
                    $('.subnav').fadeOut('fast')
                    
                $('.return-to-top').fadeIn('fast', function () {is_animated = false});

            }                      
        }               
        
        if($(window).scrollTop() + $(window).height() > $(document).height() - 100) {            
            $('.return-to-top').css({bottom:'105px'})
            $('.social-media').css({bottom:'100px'})
        } else {
            $('.return-to-top').css({bottom:'24px'})
            $('.social-media').css({bottom:'24px'})         
        }

        doMainNav ();
    }); 
    
    $('#submit-cmd').on('click touchend', function(e)  {
        if(e.type == 'touchend'){ // prevent fire twice on mobile
            $(this).off('click');
        }               
        if ($('#email').val()) {    
            $.post( "/es-ajax-mailinglist.php", { email: $('#email').val(),cmd:'submit' }).done(function( data ) {
                $('#mailing-list').fadeOut('fast',function () {
                    $('#mailing-list-thankyou').fadeIn('fast');                 
                });
            });
        } 
    })

    $('.img-only').hover (
        function() {
            if ($(this).data("hover"))
                $(this).find("img").attr("src",$(this).data("hover"));
        }, function() {
            if ($(this).data("hover"))          
                $(this).find("img").attr("src",$(this).data("default"));                
        }
    )
    
    $('.item .padding a').hover (
        function() {
            if ($(this).hasClass('change-border'))
                $( this ).closest('.article').css('border','2px solid #f26d21');
            else if ($(this).hasClass('blog-change-border'))
                $( this ).closest('.blog').css('border','2px solid #f26d21');               
        }, function() {
            if ($(this).hasClass('change-border'))
                $( this ).closest('.article').css('border','2px solid white');
            else if ($(this).hasClass('blog-change-border'))            
                $( this ).closest('.blog').css('border','2px solid #505050');
        }
    )
    
    $(window).load(function () {
        if ($('.subnav').length) {
            $('.listing').css('margin-top','130px');
        } else {
            if ($(window).width() <= 600) {
                if (!is_margin_change)
                    $('.listing').css('margin-top','0px');             
                is_margin_change = false;
            } else
                $('.listing').css('margin-top','65px');         
        }
        //resetDropmenu ();
        doResize ();
        
        $('#preloading').css({width:$(document).width(),height:$(document).height()*2})         
        $('#preloading').fadeOut('fast');   
    }); 
    
    $(window).resize(function() {
        if ($('.subnav').length) {
            $('.listing').css('margin-top','130px');
        } else {
            if ($(window).width() <= 600)
                $('.listing').css('margin-top','0px');             
            else
                $('.listing').css('margin-top','65px');         
        }
        resizeLightbox ();
        //resetDropmenu ();
        doResize ();
    });


    $('.btn-close').on('click touchend', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            $('html').css('overflow','auto');
            $('.lightbox').fadeOut('fast'); 
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });
    
    $('.lightbox-area').on('click touchend', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            if (!$(this).hasClass('none'))
                displayLightBox ($(this));
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });
        
    $('.return-to-top').on('click touchend', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            if ($('.homepage').size() && $(window).width() <= 600) {
                $('nav .home').hide();
                $('.main-nav').css('border-bottom',0)
            }
            
            $(window).scrollTop(0);
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });
    
    
    $('.lightbox .right-arrow').on('click touchend', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            var new_pos = $('.lightbox').data('position');      
            displayLightBox ($('#lb-'+(new_pos-0+1)));
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });

    $('.lightbox .left-arrow').on('click touchend', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            var new_pos = $('.lightbox').data('position');      
            displayLightBox ($('#lb-'+(new_pos-0-1)));          
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });
    
    $(document).on("click touchend", ".facebook", $.debounce(100, function(event) {
        if(touchmoved != true) {    
            var href = 'https://www.facebook.com/sharer/sharer.php?u='+$("meta[property='og:url']").attr("content");
            var link = $('<a href="' + href + '" />');
            link.attr('target', '_blank');
            window.open(link.attr('href'));
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });
    
    $('.lightbox .caption').on('click touchend','a', $.debounce(100, function(event) {
        if(touchmoved != true) {    
            if ($(this).hasClass('read-more')) {
                tmp_caption = $('.lightbox .caption').html();
                var cur_pos = $('.lightbox').data('position');      
                $('.lightbox .caption').css({'background-color':'#d1d1d1','padding-bottom':'24px'});
                $('.lightbox .caption').html($('#pc-'+cur_pos).text()+'<a class="close bc-11-1_5">CLOSE</a>');
            } else {
                $('.lightbox .caption').css({'background-color':'transparent','padding-bottom':'0px'});
                $('.lightbox .caption').html(tmp_caption);
            }
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });

    $(document).on("click touchend", ".twitter", $.debounce(100, function(event) {
        if(touchmoved != true) {    
            var href = 'http://twitter.com/share?text='+($("#twitter-msg").html()).replace(" ","+")+'&url='+$("meta[property='og:url']").attr("content");
            var link = $('<a href="' + href + '" />');
            link.attr('target', '_blank');
            window.open(link.attr('href'));
        }
    })).on('touchmove', function(e){
        touchmoved = true;
    }).on('touchstart', function(){
        touchmoved = false;
    });
});

function munge(p1,p2) {
     var box = p1 + p2;
     var a = "@";
     var dom = "cabinetmagazine";
     var dot = ".";
     var tld = "org";
     alert("You can reach us at: " + box + a + dom + dot + tld);
}