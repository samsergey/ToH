<!DOCTYPE html>
<html>
    <head>
    <meta charset='UTF-8'/>
    <script src='../lib/d3.js'></script>
    <script src='../lib/analysis.js'></script>
    <script src='../lib/functions.js'></script>
    <script src='../lib/tools.js'></script>
    <script src='../lib/matrix.js'></script>
    <script src='../lib/statistics.js'></script>
    <script src='../lib/graphics.js'></script>
    <script src='../lib/signal.js'></script>
    <script src='../lib/odesolve.js'></script>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
      .wealth .plot {
	  stroke-opacity:0.7;
      }
    </style>
    </head>
    <body></body>
    <script>
      function degenerate()
      {
	  var distr = createSVG('fig11')
	  new Graphics(distr)
	      .xRange([0,200])
	      .yRange([0,1])
	      .listPlot([[100,1]],{'needles':true})
	      .axes({yLabel : 'доля людей в группе',
		     xLabel : 'уровень богатства'})
	  var lor = createSVG('fig12',{'aspectRatio':1,'size':270})
	  new Graphics(lor,{'class' : 'Lorentz'})
	      .LorentzPlot([[0,0],[1,1]], {Gini : 0,
					   xLabel : 'доля членов группы',
					   yLabel : 'доля общей суммы'})
      }
//      degenerate()

      function poissonStrategy()
      {
	  var lst = range(0,200,2).map(i=>[i,i>134?0:Binomial(10000,1/100).PMF(i)])
	  var distr = createSVG('fig21')
	  new Graphics(distr)
	      .xRange([0,200])
	      .listPlot(lst,{'needles':true})
	      .plot(Normal(100,100).PDF)
	      .axes({ yLabel : 'доля членов группы',
		      xLabel : 'уровень богатства'})
	  var lor = createSVG('fig22',{'aspectRatio':1,'size':270})
	  new Graphics(lor,{'class' : 'Lorentz'})
	      .LorentzPlot('empty', { Gini : 0.02,
				      xLabel : 'доля членов группы',
				      yLabel : 'доля общей суммы' })
	      .plot(x=>x*(1+pow(x,1/4))/2,{'class':'lower','filled':true})
      }
//      poissonStrategy()

      function uniform()
      {
	  var distr = createSVG('fig31')
	  new Graphics(distr)
	      .xRange([0,210])
	      .yRange([0,1/150])
	      .plot(Uniform([0,200]).PDF,{'filled':true,plotPoints:400})
	      .axes({yLabel : 'доля членов группы',
		     xLabel : 'уровень богатства',
		     yTickValues : range(0,0.007,0.001),
		     yTickFormat : fmt.number
		    })
	  var lor = createSVG('fig32',{'aspectRatio':1,'size':270})
	  var h= new Histogram(2).fromDistribution(Uniform([0,100]),1000)
	  new Graphics(lor,{'class' : 'Lorentz'})
	      .LorentzPlot('empty',{ Gini : 0.33,
				     xLabel : 'доля членов группы',
				     yLabel : 'доля общей суммы' })
	      .plot(x=>x*x,{'class':'lower','filled':true})
      }
      //     uniform()

      function exchange(opts)
      {
	  var alpha = opts["alpha"] || 0
	  var beta = opts["beta"] || 0
	  var minShare = opts["minShare"] || 0
	  var bound = opts["bound"] || 0
	  
	  return function (data)
	  {
	      for(i=0;i<data.length;i++) {
		  if (data[i] >= 1)
		  {
		      d = minShare + floor(data[i]*alpha)
		      do {
			  j = randomInteger(data.length)()
			  df = min(d,minShare + floor(data[j]*beta))
			  if (bound > 0 && data[j]>=bound-df) continue
			  data[i]-=df
			  data[j]+=df
			  d-=df
		      } while (d > 0)
		  }
	      }
	      return data
	  }
      }

      function model1()
      {
	  var n = 5000, m = 100, b = 1, rep = 20
	  var strategy = exchange({'minShare':1})
	  var step = (k,p) => nest(strategy,p,k)
	  function histopts(c) {
	      return {'type':'PDF', 'class':'plot', 'filled':true, 'kind':'smooth'}
	  }
	  var fig = createSVG('fig3')
	  var hs = [new Histogram(1),new Histogram(b)
		    ,new Histogram(b),new Histogram(b)]
	  for(var i = 0; i<rep; i++)
	  {
	      var g = [m].repeat(n)
	      hs[0].fromList(g = step(1,g))
	      hs[1].fromList(g = step(8e2,g))
	      hs[2].fromList(g = step(2e3,g))
	      hs[3].fromList(g = step(1e5,g))
	      console.log(Math.round((i+1)/rep*100)+"%")
	  }
	  var p = new Graphics(fig,{'class':'wealth'})
	      .xRange([0,4*m])
	      .yRange([0,0.02])
	  range(0,4).forEach((c,i) => p.histogram(hs[i],histopts(c)))
	  p.plot(Exponential(1/m).PDF,{'class':'refference'})
	      .label('a',{'at':[110,0.019]})
	      .label('b',{'at':[130,0.01]})
	      .label('c',{'at':[170,0.004]})
	      .label('d',{'at':[30,0.008]})
	      .clipPaper()
	      .axes({xLabel:"уровень богатства",
		     yLabel:"плотность вероятности"})
      }
      // вычисляется долго
      model1()

    </script>
</html>
