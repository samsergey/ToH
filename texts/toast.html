Но плох тот математик, который не сможет отыскать что-нибудь интересненькое и в тривиальной, казалось бы, вещи.
<cut />





Разговор о законах подлости, как источнике житейских неурядиц, часто начинается со знаменитого закона бутерброда. Он просто формулируется, легко проверяется и широко известен.
<blockquote>Бутерброд всегда падает маслом вниз.</blockquote>
Понятно, что слово "всегда" здесь -- это преувеличение. Легко представить себе условия в которых бутерброд упадет, оставив намазанную маслом сторону в сохранности. Что же люди понимают, под этим законом? Скорее всего, что бутерброд падает маслом вниз достаточно часто, чтобы это было заметно и обидно. Но чаще ли происходит неблагоприятный исход падения, чем благоприятный? Бутерброды разные, падают при различных обстоятельствах, с разной высоты... Параметров столько, что говорить о закономерностях в такой задаче, наверное, нет смысла. Всяко бывает. Бывает, что падает маслом вниз, тогда обидно. Мы вспоминаем про закон и запоминаем его. А если бутерброд падает неинтересно -- маслом кверху, или если он без масла вовсе, так и говорит не о чем -- понятно же, что закон-то шуточный! В конце концов, бутерброд подобен монетке, которую математики используют для получения случайных величин с двумя возможными значениями "орёл" и "решка". Если монетка "честная", то ей абсолютно неважно какой стороной падать и мы говорим, что вероятность падения орла и решки одинаковы и равны 1/2. По идее, с бутербродами дела должны обстоять также.

Однако тут есть тонкости. Монетку в теоретиковероятностных экспериментах подбрасывают особым магическим образом, так чтобы выбор начального положения, начальной скорости и скорости закручивания монетки при подбрасывании никак не влиял на вероятность конкретного исхода. Но очевидно же что это невозможно! Монетка представляет собой механическую систему и подчиняется законам механики, а они не содержат в себе случайных величин или законов. Будущее в законах движения такого простого тела как монетка однозначно определяется прошлым состоянием этого тела. Если монетку будет подбрасывать робот, то при неизменных начальных данных, он будет получать идентичные результаты. Люди не роботы, но неужели мы подбрасываем монетки настолько неряшливо и непредсказуемо, что законы механики приводят к случайной величине?

<h3>Меняем бутерброды на монетки</h3>
Эта задача рассматривалась в 1986 году Джозефом Келлером. Мы приведём простое простое объяснение случайности процесса подбрасывания монетки, основанное на рассуждениях из статьи Келлера. То какой стороной упадёт монетка зависит только от времени её полёта $inline$t$inline$ и от угловой скорости $inline$\omega$inline$. Если измерять угловую скорость в оборотах в единицу времени, то число оборотов, совершаемое монеткой, выражается предельно просто $inline$n = t \omega$inline$. Эта зависимость задаёт линии равного числа оборотов в плоскости $inline$(t,\omega)$inline$, а они, в свою очередь, ограничивают области, соответствующие чётному и нечётному числу оборотов. Они показаны на рисунке:

На такой диаграмме можно показать каким будет результат подбрасывания монетки, закрученной, скажем на $inline$30,3$inline$ оборотов в секунду, и пойманной через полсекунды после подбрасывания. Если попадаем в белую полоску, то выпадет та же сторона, что была сверху при подбрасывании, если в оранжевую -- обратная. Линии равного числа оборотов представляют собой гиперболы и видно, что по мере увеличения числа оборотов, области становятся всё более и и более плотными. Человеческая рука несовершенна и небольшой разброс начальных значений перекрывает сразу много областей, делая исход непредсказуемым. Остаётся вопрос: а равны ли площади областей прямого и обратного положения монетки. От этого зависит насколько "честным" будет процесс подбрасывания.

Примечательно, что что площадь заштрихованных и белых областей одинакова, хоть и бесконечна. Это легко показать: $$display$$S_n = \int\limits_0^\infty \frac{n}{t}dt = n S,\quad S_{n} - S_{n-1} = (n -
 (n-1))S = S = \int\limits_0^\infty \frac{dt}{t}.$$display$$ Получается, что разница площадей не зависит от "номера" гиперболы (этот не что-то особенное, относящееся к гиперболам, тот же вывод можно сделать для любой функции вида $inline$n f(t)$inline$). А раз так, то для всей области определения, попадания в белую часть диаграммы или в заштрихованную равновероятны, как и ожидается для "честной" монетки.

Правда, в реальности мы подбрасываем монетки не со всеми возможными параметрами. Как показали эксперименты со скоростной камерой, угловые скорости попадают в диапазон от 20 до 40 оборотов в секунду, а длительность полёта -- от половины до одной секунды. Эта область выделена прямоугольником на диаграмме. В ней суммарная площадь белых полосок чуть больше чем оранжевых, и можно сделать вывод, что вероятность выпадения той же стороны, что была при подбрасывании, составит $inline$0,506$inline$.

В 2007 году серьёзный математический журнал Общества промышленной и прикладной математики Америки опубликовал статью Перси Диакониса с соавторами, в которой даётся развёрнутый анализ честности процесса подбрасывания монетки. Детальное описание механики летящей и вращающейся монетки, которая, не просто вращается вокруг какой-то оси, а ещё и прецессирует -- ось вращения сама вращается в полёте, показывает, что при ручном подбрасывании из позиции орел сверху, вероятность выпадения орла на одну сотую больше половины. 

Много это или мало? Сколько нужно провести экспериментов, чтобы заметить такую разницу? По мере накопления экспериментальных данных, стандартная ошибка среднего, отражающая погрешность, с которой может быть вычислена средняя величина, уменьшается пропорционально квадратному корню из числа испытаний. $$display$$\sigma_{\mu} = \frac{\sigma}{\sqrt{n}}$$display$$, здесь \sigma -- стандартное отклонение для исследуемого распределения. В нашем случае -- для распределения Бернулли с вероятностью $inline$0,51$inline$, которое равно $inline$\sqrt{0,51\times0,49}\approx0,5$inline$. Наша задача -- уверенно выделить отклонение среднего в одну сотую. Уверенно, это значит, что отклонение должно превышать 3 стандартных отклонения. Таким образом, мы можем оценить число испытаний: $$display$$n =
\left(\frac{\sigma}{\sigma_{\mu}}\right)^2 = \left(\frac{3\times0,5}{0,01}\right)^2 \approx 22500.$$display$$ Столько раз нужно подбросить монетку, чтобы заметить предопределённость результата. Чтобы было понятнее, что имеется ввиду, приведу пример 200 испытаний идеальной и слегка неидеальной "монеток", проводимых с целью вычислить вероятность выпадения, скажем, орла. Каждое испытание состоит в 40000 "подбрасываниях". Слова "монетка" и "подбрасывание" взяты в кавычки, оттого, что на самом деле использовалась не физическая монетка, а генератор случайных чисел, подчиняющихся распределению Бернулли.
<img src="https://habrastorage.org/webt/pq/d2/hp/pqd2hpbqdysnxmwcw19gcili-kc.png" width="70%" align="center"/><i>Эксперименты с подбрасыванием идеальной и слегка неидеальной монетки с целью зафиксировать неидеальность.</i>
Видно, что только после 20000 испытаний "облака" наблюдаемых значений среднего начинают отчётливо разделяться. Что же, для бытового использования можно считать, что монетка -- неплохой генератор случайного выбора из двух равновероятных вариантов. 

<h3>Меняем монетки на бутерброды</h3>
Но вернёмся к нашим бутербродам. Мы редко их подбрасываем как монетку, по крайней мере, когда становимся старше 2 лет. Чаще всего мы невольно повторяем примерно один и тот же эксперимент: бутерброд, изначально расположенный маслом вверх выскальзывает из рук, или соскальзывает со стола, в процессе соскальзывания закручивается, падает под действием гравитации, и, наконец, шлёпается на стол или на пол. При этом процессом управляет ряд параметров: трение о пальцы или поверхность, начальное положение бутерброда и его начальная скорость, высота падения, наконец, размеры бутерброда. Имеем динамическую систему с несколькими входными параметрами и одним выходным -- положением бутерброда на полу. Внутри системы, как и в случае с монеткой, работают механические законы, которые описываются дифференциальными уравнениями и они <i>детерминистические</i>. Это значит, что в них нет никаких случайностей -- результат зависит только от входных данных и при точном повторении параметров мы должны получать идентичные результаты. Это относится к модели бутерброда, представленной в виде системы дифференциальных уравнений, а что насчёт настоящих бутербродов, шероховатых и неповторимых, роняемых настоящими людьми в ресторанах, на улице, или на диване? Изменчивость реального мира можно описать подавая на вход детерминистической системы случайные параметры, описываемые известными распределениями. На выходе мы тоже будем получать случайную величину и в качестве результата нас может интересовать её распределение, а также такие параметры, как математическое ожидание, дисперсия и пр.

Однако, даже алгебра случайных величин, включающая в себя лишь сложение и умножение -- дело непростое, а у нас дифференциальные уравнения! Мы не полезем в эти увлекательные дебри, а используем хорошо отработанную во многих областях технику -- метод Монте-Карло. 

...

Итак, применим метод Монте-Карло для поиска ответа на вопрос: при каких обстоятельствах выполняется закон бутерброда? Будем подавать на вход нашей динамической системы различные конкретные параметры, получать конкретные результаты и набирать статистику по падениям маслом вверх и маслом вниз. Ронять тысячи бутербродов нам никто не позволит, поэтому мы воспользуемся математическим моделированием. Для решения задачи о падении бутерброда я выбрал <a href="http://brm.io/matter-js/">один</a> из доступных симуляторов физического мира, которые используют для создания игр. Он позволил создать виртуальные стол и пол, а также два бутерброда. Один оказывался на краю стола, а второй -- "выскальзывал из пальцев", то есть, соскальзывал с точечной опоры. В моих силах задавать начальные позицию и угол бутерброда, горизонтальную скорость (случай смахивания бутерброда со стола), коэффициенты трения, размеры бутерброда и высоту падения. Эксперименты выглядят как-то так:

<img src="https://habrastorage.org/webt/u5/g4/dv/u5g4dvsma2opnp2odqe5lvvetr0.gif" width="70%" align="center"/><i>Эксперименты с падением виртуальных бутербродов в симуляторе физического мира.</i>

В момент касания бутербродом пола фиксируется угол бутерброда, вернее угол вектора, нормального к нему. О том, с какой стороны оказалось масло нам скажет знак синуса этого угла: положительному значению соответствует удачный случай, а отрицательному -- положение маслом вниз. Результат заносится в таблицу, и новый виртуальный бутерброд готов к падению. Задачу мы поставим такую: оценить вероятность падения бутерброда маслом вниз при его падении с заданной высоты. 

Сначала нужно задать диапазоны и законы распределения для входных параметров. Это важная и интересная часть задачи. 

1. Размеры бутерброда. Какими они могут быть? Разумной величины канапе имеет сантиметра 3 в ширину, а студенческий добрый "лапоть" может быть сантиметров 15. Чаще всего, бутерброды имеют размеры от 6 до 10 см. При этом вероятность встретить бутерброд миллиметровой или метровой ширины, в практическом смысле, равна нулю. Больше про бутерброды я ничего сказать не могу и из соображений максимальной энтропии приму размеры бутербродов равномерно распределёнными в указанном диапазоне. 

</br>
<img src="https://habrastorage.org/webt/b1/u-/wl/b1u-wll8cteuarxk1ft1s_gzkv4.png" width="65%" align="center"/><i>Плотность распределения размеров бутерброда.</i>

Выбор неидеален, всё же нормальные бутерброды мы встречаем чаще крошечных или гигантских. Но позже мы увидим, что это слабое место можно изящно обойти.

2. Начальное положение. Тут мы не мудрствуя зададим равномерное распределение для смещения бутерброда над краем стола, лишь бы он вообще упал.

3. Коэффициент трения. Это безразмерная величина, зависящая только от материала. Столы и скатерти бывают разные, пальцы сжимают бутерброд с разной силой. Диапазон коэффициента от 0.01 до 0.5. при этом крайние значения маловероятны, в среднем можно ожидать что-то около 0.3. Тут нам поможет гамма-распределение, как распределение величины, про которую известно лишь, что она положительна, но не равна нулю, а также указано ожидаемое значение. Можно было бы взять лог-нормальное распределение, здесь это не принципиально: важно что мы ожидаем несимметричный колокол.

<img src="https://habrastorage.org/webt/p0/ck/l-/p0ckl-3smayz-cvjpjp1zhvnc-m.png" width="65%" align="center"/><i>Плотность распределения коэффициента трения.</i>

4. Начальная скорость. Мы редко запускаем бутерброды с большой скоростью, и чаще всего не кидаем их вовсе, но смахнуть, всё же, случается. Про величину скорости известно лишь, что она положительна и можно предположить, что при смахивании в среднем мы движемся также, как в среднем движутся руки, то есть, со скоростью около 0,5 метра в секунду. Если про величину известно только это, то её разумно описать экспоненциальным распределением. Его мода равна нулю, так что доля бутербродов, упавших без большой начальной скорости будет вполне приличной. В хвосте окажутся бутерброды, нечаянно запускаемые в полёт при смахивании крошек со стола.

<img src="https://habrastorage.org/webt/t-/ea/fi/t-eafiyt2bwrjbbly9ozhq6-aeq.png" width="65%" align="center"/><i>Плотность распределения начальной горизонтальной скорости.</i>

5. Высоту стола мы будем фиксировать, ронять с неё сотню бутербродов, подсчитывать число упавших маслом вниз и заносить в таблицу, либо отражать на графике вероятности от высоты.

Вот, какие вероятности уронить бутерброд маслом вниз у нас получаются после того, как мы терпеливо сбросили по сто бутербродов с каждой высоты:

<img src="https://habrastorage.org/webt/7z/nk/29/7znk29cv7cfnnbmeerouledyhma.png" width="85%" align="center"/><i>Вероятность приземления маслом вниз разных бутербродов с разными условиями в зависимости от высоты падения. Для каждой высоты бросалось 100 бутербродов.</i>

Какая-то тенденция видна, но получился очень большой разброс. При усреднении получается что вероятность от высоты падения почти не зависит едва превышает 0.5. Можно ли доверять такому эксперименту? Опровергает ли он закон бутерброда? Может быть, мы недостаточно много бросали бутербродов -- вон какие шумные получились данные! Давайте увеличим число бросаний, и посмотрим, что получится:

<img src="https://habrastorage.org/webt/jp/c1/v7/jpc1v71j7vpaqh_ek0tsoeu4kkm.png" width="85%" align="center"/><i>Вероятность приземления маслом вниз разных бутербродов посчитанная для большего числа кидаемых бутербродов (500 штук на каждую высоту).</i>

Выбросов стало меньше, но ещё более отчётливо видно, что закон бутерброда весьма и весьма слаб. Но правильно ли мы выполняли наши эксперименты? Метод Монте-Карло выглядит заманчиво простым: знай себе подставляй какие попало данные и смотри, что получается. Математика честная штука: для какой попало вопрос она готова дать какой попало ответ, но имеет ли этот ответ смысл, сильно зависит от вопроса.

Перед тем как приступать к экспериментам, не таким игрушечным, как у нас, а настоящим и дорогостоящим, использующим орбитальный спутник, ускоритель элементарных частиц или тысячу настоящих бутербродов с маслом, необходимо проводить подготовительную работу. И одним из мощных и красивых способов, позволяющих понять, как правильно проводить эксперимент, является <i>анализ размерностей</i> задачи. 


 В конце концов, и бутерброд мы моделировали, пользуясь вовсе не куском хлеба, а обобщёнными координатами, импульсами и силами -- физическими величинами, которые, в свою очередь связаны уравнениями аналитической механики. В физике количественные величины, с которыми мы имеем дело, которые мы измеряем и подставляем в уравнения тоже не "умещаются" в числа -- они имеют дополнительную структуру, которая называется <i>размерностью</i>. Не все корректные математические выражения имеют смысл, если в них участвуют размерные величины. Скажем, нет смысла складывать скорость и массу, невозможно сравнить силу и расстояние. Однако, можно рассмотреть произведение скорости и массы, получив новую размерную величину -- количество движения, или импульс; можно возвести скорость в квадрат и поделить на расстояние, получив таким образом, величину, имеющую размерность ускорения. 

Анализ размерности и теория подобия родились давно, со времён лорда Релея. Они используются в механике, электродинамике, в астрофизике и космологии, позволяя с пугающей изящность подходить к решению сложных задач. Однако исследования в этой области не завершены и строгое определение структуры, образуемой количественными (размерными) величинами было дано лишь в 2016 году испанским математиком Альваро Рапозо. Он показал, что сами по себе размерности образуют т. н. <i>свободную абелеву группу</i>, а размерные величины -- <i>локально тривиальное расслоение</i>. Я не буду здесь расшифровывать, что означают эти термины, в двух словах это не получится. Пусть для заинтересованного читателя упоминание об алгебраических структурах будет указателем направления, с которого начинается настоящая математика.

Эти ограничения на физические формулы часто воспринимаются учениками и студентами, как лишняя морока, за которой нужно следить. Но с другой стороны, логически согласованные ограничения чрезвычайно полезны! Они отсеивают неверные выражения, они позволяют "предвидеть" структуру решения физической задачи до её детального решения, они являются мощным инструментом при планировании и анализе экспериментальных данных.

А теперь смотрите, мы рассчитывали падение бутерброда в программе, используя "обыкновенные" числа. Как можно "очистить" физические величины от размерности и превратить в вещественные числа? Для этого служат хорошо нам знакомые единицы измерения физических величин: все эти метры, фунты, минуты и ньютоны. Единицы измерения берут на себя размерную часть величины, оставляя нам множитель -- вещественное число, с которым уже может иметь дело вычислительная машина. Например, скорость в выбранном направлении величиной 60 км/ч можно представить числом 60. Но тут есть тонкость: от выбора единиц измерения зависит числовое представление. При выборе других единиц (скажем, метров и секунд) <i>эта же скорость</i> будет представлена другим числом: 16,7. Числа разные, но величина одна, и она не зависит от нашего выбора каких-то единиц.  

...

Высоту стола имеет смысл измерять не в метрах, а размерах бутерброда. Этот размер задаёт масштаб всей задачи и получив результат, мы сразу можем обобщить его как на случай канапе, так и для солидного "лаптя". Итак, повторим вычисления для бутерброда фиксированного размера, изменяя высоту стола, но на графике высоту стола будем "измерять" в бутербродах. 

Начальная угловая скорость, с которой закручивается бутерброд, при соскальзывании, практически не зависит от его размеров: в этой задаче размерности массы и длины, входящие в моменты сил и в момент инерции, сокращаются, так что остаётся лишь размерность времени и угол. А вот число оборотов, которое успеет совершить в падении бутерброд зависит от времени его падения, оно, в свою очередь, определяется не только высотой стола, но и размерами бутерброда. Таким образом, перебирая различные размеры мы получали облако результатов, в котором оказалась скрыта интересующая нас зависимость. При увеличении числа бросаний, мы это облако усреднили и получили неинтересный ответ. 



Если мы всё сделали правильно, то для двух разных по размерам бутербродов мы должны получить очень похожие графики. Давайте проверим это:

<img src="https://habrastorage.org/webt/ec/-r/z1/ec-rz1taqeojtwilmxdbfcjdhfw.png" width="85%" align="center"/><i>Вероятность приземления маслом вниз бутерброда некоторой фиксированной величины, при различной высоте падения, вычисленной в относительных единицах. Зелёные точки соответствуют бутерброду размером 5 см, красные -- 10 см.</i>

Разница получилась очень выразительная и похоже, предыдущий эксперимент был, в самом деле, проведён некорректно. Чтобы ярче показать в чём состояла методическая ошибка, представьте что мы захотим вычислить вероятность падения бутерброда маслом вниз, перебирая случайным образом и начальные условия и размеры бутерброда и высоту. Это равносильно усреднению всех полученных нами результатов. В итоге мы получим уверенную серединку -- вероятность близкую к 1/2, как при подбрасывании монетки! Это очень логичный и ожидаемый результат, но он совершенно неинтересен. Усредняя множество данных для разных размеров мы уже приблизились к такому результату. Но если цель моделирования состоит в выявлении закономерности, то имеет смысл минимизировать число параметров. 

Очищенные данные теперь чётко говорят в пользу закона бутерброда, ограничивая его, однако определённым диапазоном высот: от 5 до 10 размеров бутерброда. За пределами этого диапазона у бутерброда повышается шанс повернуться нужной стороной перед падением. 

А что если заглянуть дальше, и кидать бутерброды из окна? Понятно, что при падении с большой высоты уже становится неважно какой стороной упало то, во что превратится бутерброд, но чисто теоретически, чо мы ожидаем увидеть? Наверное, должны наблюдаться колебания вероятности, с постоянно уменьшающейся частотой (пропорциональной квадратному корню расстояния, ведь время падения именно так зависит от высоты). Давайте посмотрим:

С частотой мы угадали, но любопытно, что амплитуда уменьшается, и колебания вероятности сходятся к 0.5. О чём это может говорить? При увеличении длительности полёта становятся более существенными последствия отклонений бросаний друг от друга: все эти различия в скорости, углах, отклонениях, влияют на результат тем в большей степени, чем дальше в будущее мы заглядываем. В конце концов, в общем случае, становится невозможно предсказать результат, так велико влияние начальных отклонений. Мы сталкиваемся с этим эффектом при попытках предсказать погоду или просчитать партию логической игры с элементами случайностей. Небольшие отклонения вырастают, и если пространство состояний системы ограничено, то система попадает в хаотический режим, эффективно перемешивая свой <i>фазовый объём</i> -- набор начальных состояний системы. Если в нелинейной динамической системе есть определённого рода неустойчивости, то отклонения возрастают экспоненциально и такая система может стать хаотичной даже в отсутствии случайностей, заложенных в модель. Такие системы изучает теория хаоса -- очень интересная область математики, показывающая как случайности могут возникать из детерминистических задач. 

Такой хаос может приносить и пользу. Алгоритмы, с помощью которых генерируются случайные числа в компьютерах тоже детерминированы. Для примеров в этой книге, я пользовался генератором псевдослучайных чисел, который не запускал реальный стохастический процесс (альфа-распад, или подсчёт машин на дороге), а вычислял следующее "случайное" число на базе предыдущих, полученных им ранее.

Из наблюдения за тем, как теряется информация о начальных данных запускаемого в полёт бутерброда, следует ещё один интересный и общий вывод: "эффект бабочки" почти никогда не работает. Напомню, что под этим эффектом подразумевается цепочка далеко идущих драматичных последствий от некоторого незначительного, на первый взгляд, события. Раздавленная исследователями прошлого бабочка в рассказе Рея Бредбери "И грянул гром" привела к кардинальной перестройке будущего. На этот эффект мы неявно ссылаемся, сетуя: "Не поверни я за угол, всё было бы по-другому!", "Не сел бы он в этот поезд, не случилось бы катастрофы!" или "Из-за такой мелочи разругались и разошлись!!" 

Надо понимать, что малые отклонения приводят к кардинальной перестройке системы лишь, если она неустойчива. То есть, если пара распалась из-за ерунды, ей суждено было распасться в любом случае. А если в системе множество параметров, и ряд из них случаен, то информация имеет свойство теряться и уже восстановить в какой момент в нашей жизни "всё пошло не так". И только привычка всему находить объяснение призывает нас выделять какой-то "ключевой момент". Впрочем, это уже психология, а тудя я обещал не погружаться.

По существу методом Монте-Карло мы пользовались на протяжении всей книги, и наблюдая за велосипедистами на горке, и устраивая дедлайн в офисе, и деля деньги в замкнутом обществе. Отличие тех примеров от эксперимента с бутербродом состоит в том, что сейчас нас интересовало не распределение вероятности (точное или эмпирическое), а более сложная зависимость вероятности от параметров задачи. Но какой бы несерьёзной ни была тема нашей книжки, мы говорим на языке математики, а он стремится к
точным решениям. Метод Монте Карло позволил нам получить представление о решении, но это было то, что называется грубой силой. Это не так интересно, как хоть какое-то, но аналитическое решение.
